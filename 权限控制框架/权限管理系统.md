## 数据库设计

详细表结构设计

每个表有自己的主键

字段尽量定义为not null

尽量为每个字段添加备注

数据库字段统一小写，单词之间使用下划线分隔

使用InnoDB存储引擎

可以使用varchar的字段尽可能不使用TEXT、BLOB字段

字符集选择UTF-8



部门表设计

```sql
CREATE TABLE `sys_dept` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '部门id',
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT '部门名称',
  `parent_id` int NOT NULL DEFAULT '0' COMMENT '上级部门id',
  `level` varchar(200) NOT NULL DEFAULT '' COMMENT '部门层级',
  `seq` int NOT NULL DEFAULT '0' COMMENT '部门在当前层级下的顺序，从小到大',
  `remark` varchar(200) DEFAULT '' COMMENT '备注',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次操作时间',
  `operate_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT '最后一次更新操作者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



用户表设计

```sql
CREATE TABLE `sys_user` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '用户id',
  `username` varchar(20) NOT NULL DEFAULT '' COMMENT '用户名称',
  `telephone` varchar(13) NOT NULL DEFAULT '' COMMENT '手机号',
  `mail` varchar(20) NOT NULL DEFAULT '' COMMENT '邮箱',
  `password` varchar(40) NOT NULL DEFAULT '' COMMENT '加密后的密码',
  `remark` varchar(200) DEFAULT '' COMMENT '备注',
  `dept_id` int NOT NULL COMMENT '所属部门id',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态，1：正常，0：冻结状态，2：删除',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次更新时间',
  `operate_ip` varchar(20) NOT NULL DEFAULT '' COMMENT '最后一次更新者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



权限模块表设计

```sql
CREATE TABLE `sys_acl_module` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '权限模块id',
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT '权限模块名称',
  `parent_id` int NOT NULL DEFAULT '0' COMMENT '上级权限模块id',
  `level` varchar(200) NOT NULL DEFAULT '' COMMENT '权限模块层级',
  `seq` int NOT NULL DEFAULT '0' COMMENT '权限模块在当前层级下的顺序，从小到大',
  `status` int NOT NULL DEFAULT '0' COMMENT '状态，1：正常，0：冻结',
  `remark` varchar(200) DEFAULT '' COMMENT '备注',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次操作时间',
  `operate_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT '最后一次更新操作者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



权限表设计

```sql
CREATE TABLE `sys_acl` (
  `id` int NOT NULL COMMENT '权限id',
  `code` varchar(20) NOT NULL DEFAULT '' COMMENT '权限码',
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT '权限名称',
  `acl_module_id` int NOT NULL DEFAULT '0' COMMENT '权限所属权限模块id',
  `url` varchar(100) NOT NULL DEFAULT '' COMMENT '请求url，可以填正则表达式',
  `type` int NOT NULL DEFAULT '3' COMMENT '类型，1：菜单，2：按钮，3：其他',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态，1：正常，0：冻结',
  `seq` int NOT NULL DEFAULT '0' COMMENT '权限在当前模块下的顺序',
  `remark` varchar(200) DEFAULT '' COMMENT '备注',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operator_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次更新时间',
  `operator_ip` varchar(20) NOT NULL DEFAULT '' COMMENT '最后一个更新者的ip',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



角色表设计

```sql
CREATE TABLE `sys_role` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT '角色id',
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT '角色名称',
  `type` int NOT NULL DEFAULT '0' COMMENT '角色类型，0：管理员，1：其它',
  `status` int NOT NULL DEFAULT '1' COMMENT '状态，1：正常，0：冻结',
  `remark` varchar(200) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL DEFAULT '' COMMENT '备注',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次操作时间',
  `operate_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT '最后一次更新操作者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



角色-用户表设计

```sql
CREATE TABLE `sys_role_user` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'id',
  `role_id` int NOT NULL COMMENT '角色id',
  `user_id` int NOT NULL COMMENT '用户id',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次操作时间',
  `operate_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT '最后一次更新操作者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



角色-权限表设计

```sql
CREATE TABLE `sys_role_acl` (
  `id` int NOT NULL AUTO_INCREMENT COMMENT 'id',
  `role_id` int NOT NULL COMMENT '角色id',
  `acl_id` int NOT NULL COMMENT '权限id',
  `operator` varchar(20) NOT NULL DEFAULT '' COMMENT '操作者',
  `operate_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '最后一次操作时间',
  `operate_ip` varchar(20) CHARACTER SET utf8 COLLATE utf8_bin NOT NULL DEFAULT '' COMMENT '最后一次更新操作者的ip地址',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;
```



逆向工程生成语句

java -jar mybatis-generator-core-1.3.2.jar -configfile generator.xml -overwrite

配置文件

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE generatorConfiguration PUBLIC "-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN" "http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd">
<generatorConfiguration>
	<!-- 数据库驱动包位置 -->
	<classPathEntry location="D:/IntelliJ IDEA/workplace/InformationSystem/src/main/java/generator/mysql-connector-java-5.1.34.jar" /> <!-- 1 -->
	<context id="DB2Tables" targetRuntime="MyBatis3">
		<commentGenerator>
			<property name="suppressAllComments" value="true" />
		</commentGenerator>
		<!-- 数据库链接URL、用户名、密码 -->
		<jdbcConnection driverClass="com.mysql.jdbc.Driver" connectionURL="jdbc:mysql://localhost:3306/shiro?characterEncoding=utf8" userId="root" password="001489">  <!-- 2 -->
		</jdbcConnection>
		<javaTypeResolver>
			<property name="forceBigDecimals" value="false" />
		</javaTypeResolver>
		<!-- 生成模型的包名和位置 --> <!-- 3 -->
		<javaModelGenerator targetPackage="com.hzb.model" targetProject="D:/IntelliJ IDEA/workplace/InformationSystem/src/main/java">
			<property name="enableSubPackages" value="true" />
			<property name="trimStrings" value="true" />
		</javaModelGenerator>
		<!-- 生成的映射文件包名和位置 --> <!-- 4 -->
		<sqlMapGenerator targetPackage="com.hzb.mapper" targetProject="D:/IntelliJ IDEA/workplace/InformationSystem/src/main/java">
			<property name="enableSubPackages" value="true" />
		</sqlMapGenerator>
		<!-- 生成DAO的包名和位置 --> <!-- 5 -->
		<javaClientGenerator type="XMLMAPPER" targetPackage="com.hzb.dao" targetProject="D:/IntelliJ IDEA/workplace/InformationSystem/src/main/java">
			<property name="enableSubPackages" value="true" />
		</javaClientGenerator>
		<!-- 要生成那些表(更改tableName和domainObjectName就可以) --><!-- 6 -->
		<table tableName="sys_user" domainObjectName="SysUser" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_dept" domainObjectName="SysDept" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_acl" domainObjectName="SysAcl" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_acl_module" domainObjectName="SysAclModule" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_role" domainObjectName="SysRole" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_role_acl" domainObjectName="SysRoleAcl" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_role_user" domainObjectName="SysRoleUser" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
		<table tableName="sys_log" domainObjectName="SysLog" enableCountByExample="false" enableUpdateByExample="false" enableDeleteByExample="false" enableSelectByExample="false" selectByExampleQueryId="false" />
	</context>
</generatorConfiguration>
```





## 开发环境配置

pom.xml

```xml
<properties>
    <spring.version>5.2.6.RELEASE</spring.version>
    <mybatis.version>3.4.6</mybatis.version>
    <mybatis.spring.version>1.3.2</mybatis.spring.version>
    <druid.version>1.1.18</druid.version>
    <mysql.version>5.1.46</mysql.version>
    <jackson-databind-version>2.11.0</jackson-databind-version>

    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <maven.compiler.source>1.7</maven.compiler.source>
    <maven.compiler.target>1.7</maven.compiler.target>
</properties>

<dependencies>
    <!-- SpringMVC、Spring -->
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-beans</artifactId>
        <version>${spring.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-context</artifactId>
        <version>${spring.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-web</artifactId>
        <version>${spring.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-webmvc</artifactId>
        <version>${spring.version}</version>
    </dependency>
    <dependency>
        <groupId>org.springframework</groupId>
        <artifactId>spring-jdbc</artifactId>
        <version>${spring.version}</version>
    </dependency>

    <!--MyBatis -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis</artifactId>
        <version>${mybatis.version}</version>
    </dependency>

    <!-- MyBatis整合Spring的适配包 -->
    <dependency>
        <groupId>org.mybatis</groupId>
        <artifactId>mybatis-spring</artifactId>
        <version>${mybatis.spring.version}</version>
    </dependency>

    <!-- druid-->
    <dependency>
        <groupId>com.alibaba</groupId>
        <artifactId>druid</artifactId>
        <version>1.1.18</version>
    </dependency>

    <!-- 数据库驱动 -->
    <dependency>
        <groupId>mysql</groupId>
        <artifactId>mysql-connector-java</artifactId>
        <version>${mysql.version}</version>
    </dependency>

    <!-- 返回json字符串的支持 -->
    <dependency>
        <groupId>com.fasterxml.jackson.datatype</groupId>
        <artifactId>jackson-datatype-guava</artifactId>
        <version>${jackson-databind-version}</version>
    </dependency>

    <dependency>
        <groupId>junit</groupId>
        <artifactId>junit</artifactId>
        <version>4.11</version>
        <scope>test</scope>
    </dependency>
</dependencies>
```



web.xml

```xml
<!DOCTYPE web-app PUBLIC
 "-//Sun Microsystems, Inc.//DTD Web Application 2.3//EN"
 "http://java.sun.com/dtd/web-app_2_3.dtd" >
<web-app>
  <display-name>Archetype Created Web Application</display-name>

  <listener>
    <listener-class>org.springframework.web.context.ContextLoaderListener</listener-class>
  </listener>

  <!--Spring beans 配置文件所在目录-->
  <context-param>
    <param-name>contextConfigLocation</param-name>
    <param-value>classpath:applicationContext.xml</param-value>
  </context-param>

  <!--spring mvc 配置-->
  <servlet>
    <servlet-name>spring</servlet-name>
    <servlet-class>org.springframework.web.servlet.DispatcherServlet</servlet-class>
  </servlet>
  <servlet-mapping>
    <servlet-name>spring</servlet-name>
    <url-pattern>/</url-pattern>
  </servlet-mapping>

  <filter>
    <filter-name>encodingFilter</filter-name>
    <filter-class>org.springframework.web.filter.CharacterEncodingFilter</filter-class>
    <init-param>
      <param-name>encoding</param-name>
      <param-value>UTF-8</param-value>
    </init-param>
    <init-param>
      <param-name>forceEncoding</param-name>
      <param-value>true</param-value>
    </init-param>
  </filter>
  <filter-mapping>
    <filter-name>encodingFilter</filter-name>
    <url-pattern>/*</url-pattern>
  </filter-mapping>

  <welcome-file-list>
    <welcome-file>index.jsp</welcome-file>
  </welcome-file-list>
</web-app>
```



spring-servlet.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xmlns:context="http://www.springframework.org/schema/context"
       xmlns:mvc="http://www.springframework.org/schema/mvc"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.springframework.org/schema/context https://www.springframework.org/schema/context/spring-context.xsd http://www.springframework.org/schema/mvc https://www.springframework.org/schema/mvc/spring-mvc.xsd">

    <context:annotation-config></context:annotation-config>
    <mvc:annotation-driven/>

    <context:component-scan base-package="com.mmall.controller"/>
    <context:component-scan base-package="com.mmall.service"/>

    <bean class="org.springframework.web.servlet.mvc.method.annotation.RequestMappingHandlerMapping"/>

    <bean class="org.springframework.web.servlet.view.BeanNameViewResolver"/>

    <bean id="jsonView" class="org.springframework.web.servlet.view.json.MappingJackson2JsonView"/>

    <bean class="org.springframework.web.servlet.view.InternalResourceViewResolver">
        <property name="prefix" value="/views"/>
        <property name="suffix" value=".jsp"/>
    </bean>
</beans>
```



applicationContext.xml

```xml
<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
       xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:tx="http://www.springframework.org/schema/tx"
       xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd http://www.alibaba.com/schema/stat http://www.alibaba.com/schema/stat.xsd http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd">

    <bean id="propertyConfigurer" class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer">
        <property name="ignoreUnresolvablePlaceholders" value="true"/>
        <property name="locations">
            <list>
                <value>classpath:settings.properties</value>
            </list>
        </property>
    </bean>
    <bean id="dataSource" class="com.alibaba.druid.pool.DruidDataSource" init-method="init" destroy-method="">
        <property name="driverClassName" value="${db.driverClassName}"/>
        <property name="url" value="${db.url}"/>
        <property name="username" value="${db.username}"/>
        <property name="password" value="${db.password}"/>
        <property name="initialSize" value="3"/>
        <property name="minIdle" value="3"/>
        <property name="maxActive" value="20"/>
        <property name="maxWait" value="6000"/>
        <property name="filters" value="stat,wall"/>
     </bean>

    <bean id="sqlSessionFactory" class="org.mybatis.spring.SqlSessionFactoryBean">
        <property name="configLocation" value="classpath:mybatis-config.xml"/>
        <property name="dataSource" ref="dataSource"/>
        <property name="mapperLocations" value="classpath:mapper/*.xml"/>
    </bean>

    <bean class="org.mybatis.spring.mapper.MapperScannerConfigurer">
        <property name="basePackage" value="com.mmall.dao"/>
        <property name="sqlSessionFactoryBeanName" value="sqlSessionFactory"/>
    </bean>

    <bean id="transactionManager" class="org.springframework.jdbc.datasource.DataSourceTransactionManager">
        <property name="dataSource" ref="dataSource"/>
    </bean>

    <tx:annotation-driven transaction-manager="transactionManager" />

    <bean id="stat-filter" class="com.alibaba.druid.filter.stat.StatFilter">
        <property name="slowSqlMillis" value="3000"/>
        <property name="logSlowSql" value="true"/>
        <property name="mergeSql" value="true"/>
    </bean>
    <bean id="wall-filter" class="com.alibaba.druid.wall.WallFilter">
        <property name="dbType" value="mysql"/>
    </bean>
</beans>
```



## 辅助工具类开发

项目接口定义---json、page

```java
public class JsonData {
    private boolean ret;
    private String msg;
    private Object data;

    public JsonData() {   }

    public Map<String,Object> toMap(){
        HashMap<String,Object> map = new HashMap<>();
        map.put("ret",ret);
        map.put("msg",msg);
        map.put("data",data);
        return map;
    }

    public static JsonData success(Object object,String msg){
        JsonData jsonData = new JsonData(true);
        jsonData.data = object;
        jsonData.msg = msg;
        return jsonData;
    }

    public static JsonData success(Object object){
        JsonData jsonData = new JsonData(true);
        jsonData.data = object;
        return jsonData;
    }

    public static JsonData success(){
        return new JsonData(true);
    }

    public static JsonData fail(String msg){
        JsonData jsonData = new JsonData(false);
        jsonData.msg = msg;
        return jsonData;
    }

    public JsonData(boolean ret) {
        this.ret = ret;
    }

    //get、set方法省略
}
```



接口请求全局异常处理

```java
public class SpringExceptionResolver implements HandlerExceptionResolver {
    @Override
    public ModelAndView resolveException(HttpServletRequest request, HttpServletResponse response, Object handler,Exception ex) {
        String url = request.getRequestURL().toString();
        ModelAndView mv = null;
        String defaultMsg = "System error";
        //要求项目中所有请求json数据，都使用.json结尾
        if(url.endsWith(".json")){
            if(ex instanceof PermissionException){
                JsonData jsonData = JsonData.fail(ex.getMessage());
                mv = new ModelAndView("jsonView",jsonData.toMap());
            }else{
                JsonData jsonData = JsonData.fail(defaultMsg);
                mv = new ModelAndView("jsonView",jsonData.toMap());
            }
        }else if(url.endsWith(".page")){   //要求项目中所有请求page数据，都使用.page结尾
            JsonData jsonData = JsonData.fail(defaultMsg);
            mv = new ModelAndView("exception",jsonData.toMap());
        }else{
            JsonData jsonData = JsonData.fail(defaultMsg);
            mv = new ModelAndView("jsonView",jsonData.toMap());
        }
        return mv;
    }
}
```



自定义异常

```java
public class PermissionException extends RuntimeException{
    public PermissionException(String message) {
        super(message);
    }

    public PermissionException(String message, Throwable cause) {
        super(message, cause);
    }

    public PermissionException(Throwable cause) {
        super(cause);
    }

    protected PermissionException(String message, Throwable cause, boolean enableSuppression,
                                  boolean writableStackTrace) {
        super(message, cause, enableSuppression, writableStackTrace);
    }
}
```



校验工具---validator



Json转换工具---jackson convert



获取Spring上下文---applicationContext



Http请求前后监听---interceptor





## 部门模块开发

### 新增部门

DeptParam

从前端接收参数的bean

```java
public class DeptParam {
    private Integer id;

    @NotBlank(message = "部门名称不能为空")
    @Length(max = 15,min = 2,message = "部门名称需要在2-15个字之间")
    private String name;

    private Integer parentId = 0;

    @NotNull(message = "展示顺序不可以为空")
    private Integer seq;

    @Length(max = 150,message = "备注长度不能超过150个字")
    private String remark;
    
    //get、set方法省略
}
```

controller

```java
@RequestMapping("save.json")
@ResponseBody
public JsonData saveDept(DeptParam deptParam){
    sysDeptService.save(deptParam);
    return JsonData.success();
}
```

service

```java
public void save(DeptParam deptParam){
    //利用工具类对字段进行校验
    BeanValidator.check(deptParam);
    //判断当前部门是否存在
    if(checkExist(deptParam.getParentId(),deptParam.getName(),deptParam.getId())){
        throw new ParamException("同一层级下存在相同名称的部门");
    }
    SysDept dept = new SysDept(deptParam.getName(),deptParam.getParentId(),deptParam.getSeq(),deptParam.getRemark());
    //利用工具类计算新增部门所处层级
    dept.setLevel(LevelUtil.calculateLevel(getLevel(deptParam.getParentId()),deptParam.getParentId()));
    dept.setOperator(RequestHolder.getCurrentUser().getUsername());
    dept.setOperateTime(new Date());
    dept.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    sysDeptMapper.insertSelective(dept);
}

private boolean checkExist(Integer parentId,String deptName,Integer deptId){
    return sysDeptMapper.countByNameAndParentId(parentId,deptName,deptId)>0;
}

public String getLevel(Integer parentId){
    SysDept dept = sysDeptMapper.selectByPrimaryKey(parentId);
    if(null==dept)  return null;
    return dept.getLevel();
}
```

导入依赖

```xml
<dependency>
    <groupId>org.apache.commons</groupId>
    <artifactId>commons-lang3</artifactId>
    <version>3.5</version>
</dependency>
```

LevelUtil工具类

```java
public class LevelUtil {
    //用.作为分隔符
    public final static String SEPARATOR = ".";
	//0表示根部门
    public final static String ROOT = "0";
	//计算出部门的级别
    public static String calculateLevel(String parantLevel,int parentId){
        if(StringUtils.isBlank(parantLevel)){
            return ROOT;
        }else{
            return StringUtils.join(parantLevel,SEPARATOR,parentId);
        }
    }
}
```

mapper

```xml
int countByNameAndParentId(@Param("parentId")Integer parentId,@Param("name")String name,@Param("id")Integer id);

<select id="countByNameAndParentId" parameterType="map" resultType="int">
    select count(1)
    from sys_dept
    where  name=#{name}
    <if test="parentId!=null">
        and parent_id=#{parentId}
    </if>
    <if test="id!=null">
        and id!=#{id}
    </if>
</select>
```



### 生成树结构

controller

```java
@RequestMapping("tree.json")
@ResponseBody
public JsonData tree(){
    List<DeptLevelDto> dtoList = sysTreeService.deptTree();
    return JsonData.success(dtoList);
}
```

创建dto对象

在SysDept基础上加多一个List属性，用于封装层级关系

```java
public class DeptLevelDto extends SysDept {
    private List<DeptLevelDto> deptList = Lists.newArrayList();

    //使用BeanUtils.copyProperties()进行属性复制
    public static DeptLevelDto adapt(SysDept dept){
        DeptLevelDto dto = new DeptLevelDto();
        BeanUtils.copyProperties(dept,dto);
        return dto;
    }

    @Override
    public String toString() {
        return "DeptLevelDto{" +
                "deptList=" + deptList +
                '}';
    }

    public List<DeptLevelDto> getDeptList() {
        return deptList;
    }
    public void setDeptList(List<DeptLevelDto> deptList) {
        this.deptList = deptList;
    }
}
```

service

```java
public class SysTreeService {
    @Resource
    private SysDeptMapper sysDeptMapper;

    public List<DeptLevelDto> deptTree(){
        //获取所有部门
        List<SysDept> deptList = sysDeptMapper.getAllDept();
        List<DeptLevelDto> dtoList = Lists.newArrayList();
        for(SysDept dept:deptList){
            DeptLevelDto dto = DeptLevelDto.adapt(dept);
            dtoList.add(dto);
        }
        return deptListToTree(dtoList);
    }

    public List<DeptLevelDto> deptListToTree(List<DeptLevelDto> dtoList){
        if(CollectionUtils.isEmpty(dtoList))    return Lists.newArrayList();
        //将同一级别的部门放到一起
        //Multimap存储格式：level--->{dept1,dept2...}
        Multimap<String,DeptLevelDto> levelDeptMap = ArrayListMultimap.create();
        List<DeptLevelDto> rootList = Lists.newArrayList();

        for(DeptLevelDto dto:dtoList){
            levelDeptMap.put(dto.getLevel(),dto);
            //先获取所有第一层级部门
            if(LevelUtil.ROOT.equals(dto.getLevel())){
                rootList.add(dto);
            }
        }
        //递归生成树
        transformDeptTree(rootList,LevelUtil.ROOT,levelDeptMap);
        return rootList;
    }

    public void transformDeptTree(List<DeptLevelDto> deptLevelDtoList,String level,Multimap<String,DeptLevelDto> levelDtoMultimap){
        for (int i = 0; i < deptLevelDtoList.size(); i++) {
            DeptLevelDto dto = deptLevelDtoList.get(i);
            String nextLevel = LevelUtil.calculateLevel(level,dto.getId());
            List<DeptLevelDto> tempDeptList = (List<DeptLevelDto>)levelDtoMultimap.get(nextLevel);
            if(CollectionUtils.isNotEmpty(tempDeptList)){
                Collections.sort(tempDeptList,deptSeqComparator);
                dto.setDeptList(tempDeptList);
                transformDeptTree(tempDeptList,nextLevel,levelDtoMultimap);
            }
        }
    }
	//从小到大
    public Comparator<DeptLevelDto> deptSeqComparator = new Comparator<DeptLevelDto>() {
        @Override
        public int compare(DeptLevelDto o1, DeptLevelDto o2) {
            return o1.getSeq() - o2.getSeq();
        }
    };
}
```



### 更新部门

controller

```java
@RequestMapping("update.json")
@ResponseBody
public JsonData updateDept(DeptParam deptParam){
    sysDeptService.update(deptParam);
    return JsonData.success();
}
```

service

```java
public void update(DeptParam deptParam){
    BeanValidator.check(deptParam);
    if(checkExist(deptParam.getParentId(),deptParam.getName(),deptParam.getId())){
        throw new ParamException("同一层级下存在相同名称的部门");
    }
    SysDept before = sysDeptMapper.selectByPrimaryKey(deptParam.getId());
    Preconditions.checkNotNull(before,"待更新的部门不存在");
    if(checkExist(deptParam.getParentId(),deptParam.getName(),deptParam.getId())){
        throw new ParamException("同一层级下存在相同名称的部门");
    }
    SysDept after = new SysDept(deptParam.getId(),deptParam.getName(),deptParam.getParentId(),deptParam.getSeq(),
                                deptParam.getRemark());
    after.setLevel(LevelUtil.calculateLevel(getLevel(deptParam.getParentId()),deptParam.getParentId()));
    after.setOperator(RequestHolder.getCurrentUser().getUsername());
    after.setOperateTime(new Date());
    after.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    //若当前部门的层级修改了，其下的子部门也要作出修改
    updateWithChild(before,after);
}

@Transactional
public void updateWithChild(SysDept before,SysDept after){
    String newLevelPrefix = after.getLevel();
    String oldLevelPrefix = before.getLevel();
    if(!newLevelPrefix.equals(oldLevelPrefix)){
        List<SysDept> deptList = sysDeptMapper.getChildDeptListByLevel(oldLevelPrefix);
        if(CollectionUtils.isNotEmpty(deptList)){
            for(SysDept dept:deptList){
                String level = dept.getLevel();
                if(level.indexOf(oldLevelPrefix)==0){
                    level = newLevelPrefix+level.substring(oldLevelPrefix.length());
                    dept.setLevel(level);
                }
            }
            sysDeptMapper.batchUpdateLevel(deptList);
        }
    }
    sysDeptMapper.updateByPrimaryKey(after);
}
```

mapper

```java
List<SysDept> getChildDeptListByLevel(@Param("level")String level);

void batchUpdateLevel(@Param("deptList") List<SysDept> deptList);

  <select id="getChildDeptListByLevel">
    select
    <include refid="Base_Column_List"></include>
    from sys_dept
    where level like #{level} || '.%'
  </select>

  <update id="batchUpdateLevel" parameterType="map">
    <foreach collection="deptList" item="sysDept" separator=";">
        update sys_dept
        set level = #{sysDept.level}
        where id = #{sysDept.id}
    </foreach>
  </update>
```



### 删除部门





## 用户模块开发

### 新增用户

UserParam

```java
public class UserParam {
    private Integer id;

    @NotBlank(message = "用户名不能为空")
    @Length(max = 20,min = 1,message = "用户名长度需要在20个字以内")
    private String username;

    @NotBlank(message = "电话不能为空")
    @Length(min = 1,max = 13,message = "电话长度需要在13个字以内")
    private String telephone;

    @NotBlank(message = "邮箱不能为空")
    @Length(min = 5,max = 20,message = "邮箱长度需要在20个字以内")
    private String mail;

    @NotNull(message = "必须提供用户所在部门")
    private Integer deptId;

    @NotNull(message = "必须指定用户的状态")
    @Min(value = 1,message = "用户状态不合法")
    @Max(value = 2,message = "用户状态不合法")
    private Integer status;

    @Length(min = 0,max = 200,message = "备注长度需要在200个字以内")
    private String remark;
    
    //省略get、set方法
}
```

controller

```java
@RequestMapping("save.json")
@ResponseBody
public JsonData saveUser(UserParam userParam){
    sysUserService.save(userParam);
    return JsonData.success();
}
```

service

```java
public void save(UserParam param){
    BeanValidator.check(param);
    if(checkEmailExist(param.getMail(),param.getId())){
        throw new ParamException("邮箱已被占用");
    }
    if(checkTelephoneExist(param.getTelephone(),param.getId())){
        throw new ParamException("电话已被占用");
    }
    String password = PasswordUtil.randomPassword();
    //to do
    password = "123";
    String encryptedPassword = MD5Util.encrypt(password);
    SysUser user = new SysUser(param.getUsername(),param.getTelephone(),param.getMail(),
                               encryptedPassword,param.getDeptId(),param.getStatus(),param.getRemark());
    user.setOperator("system");
    user.setOperateTime(new Date());
    user.setOperateIp("127.0.0.1");
    //sendEmail
    sysUserMapper.insertSelective(user);
}

public boolean checkEmailExist(String mail,Integer userId){
    return sysUserMapper.countByMail(mail,userId)>0;
}

public boolean checkTelephoneExist(String phone,Integer userId){
    return sysUserMapper.countByTelephone(phone,userId)>0;
}
```

随机生成密码工具类

```java
public class PasswordUtil {
    public final static String[] word = {
        "a","b","c","d","e","f","g","h","j","k","m","n",
            "o","p","q","r","s","t","u","v","w","x","y","z",
            "A","B","C","D","E","F","G","H","J","K","L","M","N",
            "O","P","Q","R","S","T","U","V","W","X","Y","Z"
    };

    public final static String[] num = {
            "2", "3", "4", "5", "6", "7", "8", "9"
    };

    public static String randomPassword(){
        StringBuffer sb = new StringBuffer();
        Random random = new Random(new Date().getTime());
        boolean flag = false;
        int length = random.nextInt(3)+8;
        for (int i = 0; i < length; i++) {
            if(flag){
                sb.append(num[random.nextInt(num.length)]);
            }else{
                sb.append(word[random.nextInt(word.length)]);
            }
            flag = !flag;
        }
        return sb.toString();
    }
}
```

MD5加密

```java
public class MD5Util {
    public final static String encrypt(String s) {
        char hexDigits[] = { '0', '1', '2', '3', '4', '5', '6', '7', '8', '9', 'A', 'B', 'C', 'D', 'E', 'F' };
        try {
            byte[] btInput = s.getBytes();
            // 获得MD5摘要算法的 MessageDigest 对象
            MessageDigest mdInst = MessageDigest.getInstance("MD5");
            // 使用指定的字节更新摘要
            mdInst.update(btInput);
            // 获得密文
            byte[] md = mdInst.digest();
            // 把密文转换成十六进制的字符串形式
            int j = md.length;
            char str[] = new char[j * 2];
            int k = 0;
            for (int i = 0; i < j; i++) {
                byte byte0 = md[i];
                str[k++] = hexDigits[byte0 >>> 4 & 0xf];
                str[k++] = hexDigits[byte0 & 0xf];
            }
            return new String(str);
        } catch (Exception e) {
            //log.error("generate md5 error, {}", s, e);
            return null;
        }
    }
}
```



### 用户登录

controller

```java
@RequestMapping("login.page")
public void login(HttpServletRequest request, HttpServletResponse response) throws IOException, ServletException {
    String username = request.getParameter("username");
    String password = request.getParameter("password");
    //根据用户名查找是否存在该用户
    SysUser sysUser = sysUserService.findByKeyword(username);
    String errorMsg = "";
    String ret = request.getParameter("ret");
    if(StringUtils.isBlank(username)){
        errorMsg = "用户名不可以为空";
    }else if(StringUtils.isBlank(password)){
        errorMsg = "密码不可以为空";
    }else if(sysUser==null){
        errorMsg = "查询不到指定用户";
    }else if(!sysUser.getPassword().equals(MD5Util.encrypt(password))){
        errorMsg = "用户名或密码错误";
    }else if(sysUser.getStatus()!=1){
        errorMsg = "用户已被冻结，请联系管理员";
    }else{
        //将当前用户保存到session中
        request.getSession().setAttribute("user",sysUser);
        if(StringUtils.isNotBlank(ret)){
            response.sendRedirect(ret);
        }else{
            response.sendRedirect("/admin/index.page");
        }
    }
    request.setAttribute("error",errorMsg);
    request.setAttribute("username",username);
    if(StringUtils.isNotBlank(ret)){
        request.setAttribute("ret",ret);
    }
    String path = "signin.jsp";
    request.getRequestDispatcher(path).forward(request,response);
}
```

service

```java
public SysUser findByKeyword(String keyword){
    return sysUserMapper.findByKeyword(keyword);
}
```

mapper

```xml
 SysUser findByKeyword(@Param("keyword") String keyword);

<select id="findByKeyword" parameterType="string" resultMap="BaseResultMap">
    select <include refid="Base_Column_List"></include>
    from sys_user
    where telephone = #{keyword}
    or mail = #{keyword}
</select>
```



### 用户退出

controller

```java
@RequestMapping("logout.page")
public void logout(HttpServletRequest request, HttpServletResponse response) throws IOException {
    request.getSession().invalidate();
    String path = "signin.jsp";
    response.sendRedirect(path);
}
```



### 用户分页列表

PageQuery/PageResult

```java
//封装分页参数
public class PageQuery {
    @Min(value = 1,message = "当前页码不合法")
    private int pageNo = 1;

    @Min(value = 1,message = "每页展示数量不合法")
    private int pageSize = 10;

    private int offset;
    
    //省略其他方法
}
//分页结果集
public class PageResult<T> {
    private List<T> data = new ArrayList<>();

    private int total = 0;
    
    //省略其他方法
}
```

controller

```java
@RequestMapping("page.json")
@ResponseBody
public JsonData page(@RequestParam("deptId")Integer deptId, PageQuery pageQuery){
    PageResult<SysUser> pageByDeptId = sysUserService.getPageByDeptId(deptId, pageQuery);
    return JsonData.success(pageByDeptId);
}
```

service

```java
public PageResult<SysUser> getPageByDeptId(int deptId, PageQuery pageQuery){
    BeanValidator.check(pageQuery);
    int count = sysUserMapper.countByDeptId(deptId);
    if(count>0){
        List<SysUser> list = sysUserMapper.getPageByDeptId(deptId,pageQuery);
        return new PageResult<SysUser>(list,count);
    }else{
        return new PageResult<SysUser>();
    }
}
```

mapper

```xml
int countByDeptId(@Param("deptId")int deptId);

List<SysUser> getPageByDeptId(@Param("deptId")int deptId, @Param("page")PageQuery page);

  <select id="countByDeptId" parameterType="int" resultType="int">
    select count(1)
    from sys_dept
    where  dept_id=#{deptId}
  </select>

  <select id="getPageByDeptId" parameterType="map" resultType="BaseResultMap">
    select <include refid="Base_Column_List"></include>
    from sys_user
    where  dept_id=#{deptId}
    order by username asc
    limit #{page.offset},#{page.pageSize}
  </select>
```



### ThreadLocal,LoginFilter登录请求拦截

RequestHolder

```java
public class RequestHolder {
    private static final ThreadLocal<SysUser> userHolder = new ThreadLocal<>();

    private static final ThreadLocal<HttpServletRequest> requestHolder = new ThreadLocal<>();

    public static void add(SysUser user){
        userHolder.set(user);
    }

    public static void add(HttpServletRequest request){
        requestHolder.set(request);
    }

    public static SysUser getCurrentUser(){
        return userHolder.get();
    }

    public static HttpServletRequest getCurrentRequest(){
        return requestHolder.get();
    }
	//在拦截器的postHandle和afterCompletion方法中调用该方法进行移除
    public static void remove(){
        userHolder.remove();
        requestHolder.remove();
    }
}
```

LoginFilter

```java
public class LoginFilter implements Filter {
    @Override
    public void init(FilterConfig filterConfig) throws ServletException {    }

    @Override
    public void doFilter(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain) throws IOException, ServletException {
        HttpServletRequest request = (HttpServletRequest) servletRequest;
        HttpServletResponse response = (HttpServletResponse) servletResponse;
        SysUser user = (SysUser) request.getSession().getAttribute("user");
        if(null==user){
            String path = "/signin.jsp";
            response.sendRedirect(path);
            return;
        }
        RequestHolder.add(user);
        RequestHolder.add(request);
        filterChain.doFilter(servletRequest,servletResponse);
    }

    @Override
    public void destroy() {    }
}
```

在web.xml中注册filter

```xml
<filter>
    <filter-name>loginFilter</filter-name>
    <filter-class>com.mmall.filter.LoginFilter</filter-class>
</filter>
<filter-mapping>
    <filter-name>loginFilter</filter-name>
    <url-pattern>/sys/*</url-pattern>
    <url-pattern>/admin/*</url-pattern>
</filter-mapping>
```



## 权限模块

### 新增权限模块

AclModuleParam

```java
public class AclModuleParam {
    private Integer id;

    @NotBlank(message = "权限模块名称不可以为空")
    @Length(min = 2, max = 20, message = "权限模块名称长度需要在2~20个字之间")
    private String name;

    private Integer parentId = 0;

    @NotNull(message = "权限模块展示顺序不可以为空")
    private Integer seq;

    @NotNull(message = "权限模块状态不可以为空")
    @Min(value = 0, message = "权限模块状态不合法")
    @Max(value = 1, message = "权限模块状态不合法")
    private Integer status;

    @Length(max = 200, message = "权限模块备注需要在200个字之间")
    private String remark;
    
    //省略get、set方法
}
```

controller

```java
@RequestMapping("/save.json")
@ResponseBody
public JsonData saveAclModule(AclModuleParam param) {
    sysAclModuleService.save(param);
    return JsonData.success();
}
```

service

```java
public void save(AclModuleParam param){
    BeanValidator.check(param);
    if(checkExist(param.getParentId(), param.getName(), param.getId())) {
        throw new ParamException("同一层级下存在相同名称的权限模块");
    }
    SysAclModule aclModule = new SysAclModule(param.getName(),param.getParentId(),param.getSeq(),param.getStatus(),param.getRemark());
    aclModule.setLevel(LevelUtil.calculateLevel(getLevel(param.getParentId()), param.getParentId()));
    aclModule.setOperator(RequestHolder.getCurrentUser().getUsername());
    aclModule.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    aclModule.setOperateTime(new Date());
    sysAclModuleMapper.insertSelective(aclModule);
}

private boolean checkExist(Integer parentId, String aclModuleName, Integer deptId) {
    return sysAclModuleMapper.countByNameAndParentId(parentId, aclModuleName, deptId) > 0;
}
```

mapper

```xml
int countByNameAndParentId(@Param("parentId")Integer parentId, @Param("name")String name, @Param("id")Integer id);

  <select id="countByNameAndParentId" parameterType="map" resultType="int">
    select count(1)
    from sys_acl_module
    where  name=#{name}
    <if test="parentId!=null">
      and parent_id=#{parentId}
    </if>
    <if test="id!=null">
      and id!=#{id}
    </if>
  </select>
```



### 更新权限模块

controller

```java
@RequestMapping("/update.json")
@ResponseBody
public JsonData updateAclModule(AclModuleParam param) {
    sysAclModuleService.update(param);
    return JsonData.success();
}
```

service

```java
public void update(AclModuleParam param){
    BeanValidator.check(param);
    if(checkExist(param.getParentId(), param.getName(), param.getId())) {
        throw new ParamException("同一层级下存在相同名称的权限模块");
    }
    SysAclModule before = sysAclModuleMapper.selectByPrimaryKey(param.getId());
    Preconditions.checkNotNull(before, "待更新的权限模块不存在");

    SysAclModule after = new SysAclModule(param.getName(),param.getParentId(),param.getSeq(),param.getStatus(),param.getRemark());
    after.setLevel(LevelUtil.calculateLevel(getLevel(param.getParentId()), param.getParentId()));
    after.setOperator(RequestHolder.getCurrentUser().getUsername());
    after.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    after.setOperateTime(new Date());

    updateWithChild(before, after);
}
@Transactional
public void updateWithChild(SysAclModule before,SysAclModule after){
    String newLevelPrefix = after.getLevel();
    String oldLevelPrefix = before.getLevel();
    if (!after.getLevel().equals(before.getLevel())) {
        List<SysAclModule> aclModuleList = sysAclModuleMapper.getChildAclModuleListByLevel(before.getLevel());
        if (CollectionUtils.isNotEmpty(aclModuleList)) {
            for (SysAclModule aclModule : aclModuleList) {
                String level = aclModule.getLevel();
                if (level.indexOf(oldLevelPrefix) == 0) {
                    level = newLevelPrefix + level.substring(oldLevelPrefix.length());
                    aclModule.setLevel(level);
                }
            }
            sysAclModuleMapper.batchUpdateLevel(aclModuleList);
        }
    }
    sysAclModuleMapper.updateByPrimaryKeySelective(after);
}
```

mapper

```xml
List<SysAclModule> getChildAclModuleListByLevel(@Param("level")String level);

void batchUpdateLevel(@Param("sysAclModuleList") List<SysAclModule> sysAclModulesList);
    
 <select id="getChildAclModuleListByLevel">
    select
    <include refid="Base_Column_List"></include>
    from sys_acl_module
    where level like #{level} || '.%'
  </select>

  <update id="batchUpdateLevel" parameterType="map">
    <foreach collection="sysAclModuleList" item="sysAclModule" separator=";">
      update sys_acl_module
      set level = #{sysAclModule.level}
      where id = #{sysAclModule.id}
    </foreach>
  </update>
```



### 构建权限树

controller

```java
@RequestMapping("/tree.json")
@ResponseBody
public JsonData tree() {
    return JsonData.success(sysTreeService.aclModuleTree());
}
```

创建dto对象

在SysAclModule基础上加多一个aclModuleList属性，用于封装层级关系

```java
public class AclModuleLevelDto extends SysAclModule {
    private List<AclModuleLevelDto> aclModuleList = Lists.newArrayList();

    private List<AclDto> aclList = Lists.newArrayList();

    public static AclModuleLevelDto adapt(SysAclModule aclModule){
        AclModuleLevelDto dto = new AclModuleLevelDto();
        BeanUtils.copyProperties(aclModule,dto);
        return dto;
    }
}
```

service

```java
public List<AclModuleLevelDto> aclModuleTree(){
    //获取所有部门
    List<SysAclModule> aclModuleList = sysAclModuleMapper.getAllAclModule();
    List<AclModuleLevelDto> dtoList = Lists.newArrayList();
    for(SysAclModule aclModule:aclModuleList){
        AclModuleLevelDto dto = AclModuleLevelDto.adapt(aclModule);
        dtoList.add(dto);
    }
    return aclModuleListToTree(dtoList);
}

public List<AclModuleLevelDto> aclModuleListToTree(List<AclModuleLevelDto> dtoList){
    if(CollectionUtils.isEmpty(dtoList))    return Lists.newArrayList();
    //将同一级别的权限模块放到一起
    //Multimap存储格式：level--->{aclModule1,aclModule2...}
    Multimap<String,AclModuleLevelDto> levelDeptMap = ArrayListMultimap.create();
    List<AclModuleLevelDto> rootList = Lists.newArrayList();

    for(AclModuleLevelDto dto:dtoList){
        levelDeptMap.put(dto.getLevel(),dto);
        //先获取所有第一层级权限模块
        if(LevelUtil.ROOT.equals(dto.getLevel())){
            rootList.add(dto);
        }
    }
    //递归生成树
    transformAclModuleTree(rootList,LevelUtil.ROOT,levelDeptMap);
    return rootList;
}

public void transformAclModuleTree(List<AclModuleLevelDto> aclModuleLevelDtoList,String level,Multimap<String,AclModuleLevelDto> levelDtoMultimap){
    for (int i = 0; i < aclModuleLevelDtoList.size(); i++) {
        AclModuleLevelDto dto = aclModuleLevelDtoList.get(i);
        String nextLevel = LevelUtil.calculateLevel(level,dto.getId());
        List<AclModuleLevelDto> tempAclModuleList = (List<AclModuleLevelDto>)levelDtoMultimap.get(nextLevel);
        if(CollectionUtils.isNotEmpty(tempAclModuleList)){
            Collections.sort(tempAclModuleList,aclModuleSeqComparator);
            dto.setAclModuleList(tempAclModuleList);
            transformAclModuleTree(tempAclModuleList,nextLevel,levelDtoMultimap);
        }
    }
}

public Comparator<AclModuleLevelDto> aclModuleSeqComparator = new Comparator<AclModuleLevelDto>() {
    @Override
    public int compare(AclModuleLevelDto o1, AclModuleLevelDto o2) {
        return o1.getSeq() - o2.getSeq();
    }
};
```

mapper

```xml
List<SysAclModule> getAllAclModule();

  <select id="getAllAclModule" resultMap="BaseResultMap">
    select
    <include refid="Base_Column_List"></include>
    from sys_acl_module
  </select>
```



## 权限点模块

AclParam

```java
public class AclParam {
    private Integer id;

    @NotBlank(message = "权限点名称不可以为空")
    @Length(min = 2, max = 20, message = "权限点名称长度需要在2-20个字之间")
    private String name;

    @NotNull(message = "必须指定权限模块")
    private Integer aclModuleId;

    @Length(min = 6, max = 100, message = "权限点URL长度需要在6-100个字符之间")
    private String url;

    @NotNull(message = "必须指定权限点的类型")
    @Min(value = 1, message = "权限点类型不合法")
    @Max(value = 3, message = "权限点类型不合法")
    private Integer type;

    @NotNull(message = "必须指定权限点的状态")
    @Min(value = 0, message = "权限点状态不合法")
    @Max(value = 1, message = "权限点状态不合法")
    private Integer status;

    @NotNull(message = "必须指定权限点的展示顺序")
    private Integer seq;

    @Length(min = 0, max = 200, message = "权限点备注长度需要在200个字符以内")
    private String remark;
	
    //省略get、set方法
}
```

### 新增权限点

controller

```java
@RequestMapping("/save.json")
@ResponseBody
public JsonData saveAclModule(AclParam param) {
    sysAclService.save(param);
    return JsonData.success();
}
```

service

```java
public void save(AclParam param){
    BeanValidator.check(param);
    if(checkExist(param.getAclModuleId(),param.getName(),param.getId())){
        throw new ParamException("当前权限模块下存在同名权限点");
    }
    SysAcl acl = new SysAcl(param.getName(),param.getAclModuleId(),param.getUrl(),param.getType(),param.getStatus(),param.getSeq(),param.getRemark());
    acl.setCode(generateCode());
    acl.setOperator(RequestHolder.getCurrentUser().getUsername());
    acl.setOperatorTime(new Date());
    acl.setOperatorIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    sysAclMapper.insertSelective(acl);
}

public String generateCode() {
    SimpleDateFormat dateFormat = new SimpleDateFormat("yyyyMMddHHmmss");
    return dateFormat.format(new Date()) + "_" + (int)(Math.random() * 100);
}

public boolean checkExist(int aclModuleId,String name,Integer id){
    return sysAclMapper.countByNameAndAclModuleId(aclModuleId, name, id) > 0;
}
```

mapper

```xml
int countByNameAndAclModuleId(@Param("parentId") int aclModuleId, @Param("name") String name,@Param("id") Integer id);

  <select id="countByNameAndAclModuleId" parameterType="map" resultType="int">
    SELECT count(1)
    FROM sys_acl
    WHERE acl_module_id = #{aclModuleId}
    AND name = #{name}
    <if test="id != null">
      AND id != #{id}
    </if>
  </select>
```



### 更新权限点

controller

```java
@RequestMapping("/update.json")
@ResponseBody
public JsonData updateAclModule(AclParam param) {
    sysAclService.update(param);
    return JsonData.success();
}
```

service

```java
public void update(AclParam param){
    BeanValidator.check(param);
    if (checkExist(param.getAclModuleId(), param.getName(), param.getId())) {
        throw new ParamException("当前权限模块下面存在相同名称的权限点");
    }
    SysAcl before = sysAclMapper.selectByPrimaryKey(param.getId());
    Preconditions.checkNotNull(before, "待更新的权限点不存在");

    SysAcl after = new SysAcl(param.getName(),param.getAclModuleId(),param.getUrl(),param.getType(),param.getStatus(),param.getSeq(),param.getRemark());
    after.setOperator(RequestHolder.getCurrentUser().getUsername());
    after.setOperatorTime(new Date());
    after.setOperatorIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));

    sysAclMapper.updateByPrimaryKeySelective(after);
}
```



### 权限点分页列表

controller

```java
@RequestMapping("/page.json")
@ResponseBody
public JsonData list(@RequestParam("aclModuleId") Integer aclModuleId, PageQuery pageQuery) {
    return JsonData.success(sysAclService.getPageByAclModuleId(aclModuleId, pageQuery));
}
```

service

```java
public PageResult<SysAcl> getPageByAclModuleId(int aclModuleId, PageQuery page) {
    BeanValidator.check(page);
    int count = sysAclMapper.countByAclModuleId(aclModuleId);
    if (count > 0) {
        List<SysAcl> aclList = sysAclMapper.getPageByAclModuleId(aclModuleId, page);
        return new PageResult<SysAcl>(aclList,count);
    }
    return new PageResult<SysAcl>();
}
```

mapper

```xml
int countByAclModuleId(@Param("aclModuleId") int aclModuleId);

List<SysAcl> getPageByAclModuleId(@Param("aclModuleId")int aclModuleId,@Param("page") PageQuery page);
    
  <select id="countByAclModuleId" parameterType="map" resultType="int">
    SELECT count(1)
    FROM sys_acl
    WHERE acl_module_id = #{aclModuleId}
  </select>

  <select id="getPageByAclModuleId" parameterType="map" resultMap="BaseResultMap">
    SELECT <include refid="Base_Column_List" />
    FROM sys_acl
    WHERE acl_module_id = #{aclModuleId}
    ORDER BY seq ASC, name ASC
    limit #{page.offset}, #{page.pageSize}
  </select>
```



## 角色模块

RoleParam

```java
public class RoleParam {
    private Integer id;

    @NotBlank(message = "角色名称不可以为空")
    @Length(min = 2, max = 20, message = "角色名称长度需要在2-20个字之间")
    private String name;

    @Min(value = 1, message = "角色类型不合法")
    @Max(value = 2, message = "角色类型不合法")
    private Integer type = 1;

    @NotNull(message = "角色状态不可以为空")
    @Min(value = 0, message = "角色状态不合法")
    @Max(value = 1, message = "角色状态不合法")
    private Integer status;

    @Length(min = 0, max = 200, message = "角色备注长度需要在200个字符以内")
    private String remark;
    
    //省略get、set方法
}
```

### 新增角色

controller

```java
@RequestMapping("save.json")
@ResponseBody
public JsonData saveRole(RoleParam param){
    sysRoleService.save(param);
    return JsonData.success();
}
```

service

```java
public void save(RoleParam param){
    BeanValidator.check(param);
    if(checkExist(param.getName(),param.getId())){
        throw new ParamException("角色名称已存在");
    }
    SysRole role = new SysRole(param.getName(),param.getStatus(),param.getType(),param.getRemark());
    role.setOperator(RequestHolder.getCurrentUser().getUsername());
    role.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    role.setOperateTime(new Date());
    sysRoleMapper.insertSelective(role);
}

public boolean checkExist(String name,Integer id){
    return sysRoleMapper.countByName(name,id)>0;
}
```

mapper

```xml
int countByName(@Param("name")String name,@Param("id")Integer id);

  <select id="countByName" parameterType="map" resultType="int">
    select count(1)
    from sys_role
    where name = #{name}
    <if test="id!=null">
      and id != #{id}
    </if>
  </select>
```



### 更新角色

controller

```java
@RequestMapping("update.json")
@ResponseBody
public JsonData updateRole(RoleParam param){
    sysRoleService.update(param);
    return JsonData.success();
}
```

service

```java
public void update(RoleParam param){
    BeanValidator.check(param);
    if(checkExist(param.getName(),param.getId())){
        throw new ParamException("角色名称已存在");
    }
    SysRole before = sysRoleMapper.selectByPrimaryKey(param.getId());
    Preconditions.checkNotNull(before,"待更新的角色不存在");
    SysRole after = new SysRole(param.getId(),param.getName(),param.getStatus(),param.getType(),param.getRemark());
    after.setOperator(RequestHolder.getCurrentUser().getUsername());
    after.setOperateIp(IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
    after.setOperateTime(new Date());
    sysRoleMapper.updateByPrimaryKeySelective(after);
}
```



## 角色权限关系

controller

```java
@RequestMapping("changeAcls.json")
@ResponseBody
public JsonData changeAcls(@RequestParam("roleId")int roleId,@RequestParam(value = "aclIds",required = false,defaultValue = "")String aclIds){
    //将字符串集合转变为整型集合
    List<Integer> aclIdList = StringUtil.splitToListInt(aclIds);
    sysRoleAclService.changeRoleAcls(roleId,aclIdList);
    return JsonData.success();
}
```

StringUtil

```java
public class StringUtil {
    public static List<Integer> splitToListInt(String str){
        List<String> strList = Splitter.on(",").trimResults().omitEmptyStrings().splitToList(str);
        List<Integer> list = strList.stream().map(strItem -> Integer.parseInt(strItem)).collect(Collectors.toList());
        return list;
    }
}
```

service

```java
public void changeRoleAcls(Integer roleId,List<Integer> aclIdList){
    List<Integer> originAclIdList = sysRoleAclMapper.getAclIdListByRoleIdList(Lists.newArrayList(roleId));
    //防止用户重复点击
    if(originAclIdList.size()==aclIdList.size()){
        Set<Integer> originAclIdSet = Sets.newHashSet(originAclIdList);
        Set<Integer> aclIdSet = Sets.newHashSet(aclIdList);
        originAclIdList.removeAll(aclIdSet);
        if(CollectionUtils.isEmpty(originAclIdSet)){
            return;
        }
    }
    updateRoleAcls(roleId,aclIdList);
}

@Transactional
public void updateRoleAcls(int roleId, List<Integer> aclIdList) {
    //先删除原有数据，防止插入时出现主键冲突
    sysRoleAclMapper.deleteByRoleId(roleId);

    if (CollectionUtils.isEmpty(aclIdList)) {
        return;
    }
    List<SysRoleAcl> roleAclList = Lists.newArrayList();
    for(Integer aclId : aclIdList) {
        SysRoleAcl roleAcl = new SysRoleAcl(roleId,aclId,RequestHolder.getCurrentUser().getUsername(),
                                            new Date(),IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
        roleAclList.add(roleAcl);
    }
    sysRoleAclMapper.batchInsert(roleAclList);
}
```

mapper

```xml
List<Integer> getAclIdListByRoleIdList(@Param("userRoleIdList") List<Integer> userRoleIdList);

void deleteByRoleId(@Param("roleId")int roleId);

void batchInsert(@Param("roleAclList")List<SysRoleAcl> roleAclList);
    
  <select id="getAclIdListByRoleIdList" parameterType="map" resultType="int">
    select acl_id
    from sys_role_acl
    where role_id in
    <foreach collection="roleIdList" item="roleId" open="(" separator="," close=")">
      #{roleId}
    </foreach>
  </select>
    
  <delete id="deleteByRoleId" parameterType="int">
    delete from sys_role_acl
    where role_id = #{roleId}
  </delete>

  <insert id="batchInsert" parameterType="map">
    insert into sys_role_acl (role_id, acl_id, operator, operate_time, operate_ip)
    values
    <foreach collection="roleAclList" item="roleAcl" separator=",">
      (#{roleAcl.roleId}, #{roleAcl.aclId}, #{roleAcl.operator}, #{roleAcl.operateTime}, #{roleAcl.operateIp})
    </foreach>
  </insert>
```



## 角色用户关系

展示列表

controller

```java
@RequestMapping("users.json")
@ResponseBody
public JsonData users(@RequestParam("roleId")int roleId){
    //当前角色下的用户
    List<SysUser> selectedUserList = sysRoleUserService.getListByRoleId(roleId);
    //所有用户
    List<SysUser> allUserList = sysUserService.getAll();
    List<SysUser> unselectedUserList = Lists.newArrayList();
    Set<Integer> selectedUserIdSet = selectedUserList.stream().map(sysUser -> sysUser.getId()).collect(Collectors.toSet());
    for(SysUser user:allUserList){
        if(user.getStatus()==1 && !selectedUserIdSet.contains(user.getId())){
            unselectedUserList.add(user);
        }
    }
    //展示所有已选和未选的用户
    Map<String,List<SysUser>> map = Maps.newHashMap();
    map.put("selected",selectedUserList);
    map.put("unselected",unselectedUserList);
    return JsonData.success(map);
}
```

service

```java
public List<SysUser> getListByRoleId(int roleId){
    List<Integer> userIdList = sysRoleUserMapper.getUserIdListByRoleId(roleId);
    if(CollectionUtils.isEmpty(userIdList)){
        return Lists.newArrayList();
    }
    return sysUserMapper.getByIdList(userIdList);
}
```

mapper

```xml
List<Integer> getUserIdListByRoleId(@Param("roleId")int roleId);
    
  <select id="getUserIdListByRoleId" parameterType="int" resultType="int">
    select role_id
    from sys_role_user
    where role_id=#{roleId}
  </select>
```



修改角色用户关系

controller

```java
@RequestMapping("changeUsers.json")
@ResponseBody
public JsonData changeUsers(@RequestParam("roleId")int roleId,@RequestParam(value = "userIds",required = false,defaultValue = "")String userIds){
    List<Integer> userIdList = StringUtil.splitToListInt(userIds);
    sysRoleUserService.changeRoleUsers(roleId,userIdList);
    return JsonData.success();
}
```

service

```java
public void changeRoleUsers(int roleId, List<Integer> userIdList) {
    List<Integer> originUserIdList = sysRoleUserMapper.getUserIdListByRoleId(roleId);
    //防止用户重复点击,判断传入的集合是否与原来相同
    if(originUserIdList.size()==userIdList.size()){
        Set<Integer> originUserIdSet = Sets.newHashSet(originUserIdList);
        Set<Integer> userIdSet = Sets.newHashSet(userIdList);
        originUserIdList.removeAll(userIdSet);
        if(CollectionUtils.isEmpty(originUserIdSet)){
            return;
        }
    }
    updateRoleUsers(roleId,userIdList);
}

@Transactional
public void updateRoleUsers(int roleId, List<Integer> userIdList) {
    //先删除原有数据，防止插入时出现主键冲突
    sysRoleUserMapper.deleteByRoleId(roleId);

    if (CollectionUtils.isEmpty(userIdList)) {
        return;
    }
    List<SysRoleUser> roleUserList = Lists.newArrayList();
    for(Integer userId : userIdList) {
        SysRoleUser roleUser = new SysRoleUser(roleId,userId, RequestHolder.getCurrentUser().getUsername(),
                                               new Date(), IpUtil.getRemoteIp(RequestHolder.getCurrentRequest()));
        roleUserList.add(roleUser);
    }
    sysRoleUserMapper.batchInsert(roleUserList);
}
```

mapper

```xml
List<Integer> getUserIdListByRoleId(@Param("roleId")int roleId);

void deleteByRoleId(@Param("roleId")int roleId);

void batchInsert(@Param("roleUserList")List<SysRoleUser> sysRoleUserList);
    
  <select id="getUserIdListByRoleId" parameterType="int" resultType="int">
    select role_id
    from sys_role_user
    where role_id=#{roleId}
  </select>

  <delete id="deleteByRoleId" parameterType="int">
    delete from sys_role_user
    where role_id=#{roleId}
  </delete>

  <insert id="batchInsert" parameterType="map">
    insert into sys_role_user (role_id, user_id, operator, operate_time, operate_ip)
    values
    <foreach collection="roleUserList" item="roleUser" separator=",">
      ( #{roleUser.roleId}, #{roleUser.userId}, #{roleUser.operator}, #{roleUser.operateTime}, #{roleUser.operateIp})
    </foreach>
  </insert>
```





























































